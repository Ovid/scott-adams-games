use Test::Most 'bail';
use FindBin;
require "$FindBin::Bin/../bin/scott.pl";

my $database = 't/data/adv00';

lives_ok { ::LoadDatabase($database) }
'Loading a valid database should succeed';

my $expected_headers = {
    LightTime    => 125,
    MaxCarry     => 6,
    NumActions   => 169,
    NumItems     => 65,
    NumMessages  => 75,
    NumRooms     => 33,
    NumWords     => 69,
    PlayerRoom   => 11,
    TreasureRoom => 3,
    Treasures    => 3,
    Unknown1     => 0,
    Unknown2     => 0,
    WordLength   => 3
};
eq_or_diff \%::GameHeader, $expected_headers,
	'... and the headers read from the db should be correct';

my $expected_actions = [
    { Action => [ 17612, 0 ],     Condition => [ 161,  386,  160,  200,  0 ],   Vocab => 75 },
    { Action => [ 2011,  0 ],     Condition => [ 421,  667,  0,    0,    0 ],   Vocab => 10 },
    { Action => [ 1874,  8850 ],  Condition => [ 401,  420,  400,  146,  0 ],   Vocab => 10 },
    { Action => [ 2622,  0 ],     Condition => [ 523,  520,  260,  349,  0 ],   Vocab => 8 },
    { Action => [ 8312,  9064 ],  Condition => [ 108,  760,  820,  420,  100 ], Vocab => 100 },
    { Action => [ 5613,  0 ],     Condition => [ 484,  0,    0,    0,    0 ],   Vocab => 100 },
    { Action => [ 6062,  0 ],     Condition => [ 141,  140,  20,   246,  0 ],   Vocab => 5 },
    { Action => [ 11145, 0 ],     Condition => [ 406,  426,  400,  842,  146 ], Vocab => 8 },
    { Action => [ 2311,  0 ],     Condition => [ 482,  152,  0,    0,    0 ],   Vocab => 8 },
    { Action => [ 8626,  0 ],     Condition => [ 104,  308,  0,    0,    0 ],   Vocab => 100 },
    { Action => [ 7259,  7800 ],  Condition => [ 161,  246,  160,  1100, 0 ],   Vocab => 50 },
    { Action => [ 9062,  9900 ],  Condition => [ 148,  140,  940,  500,  0 ],   Vocab => 100 },
    { Action => [ 11145, 0 ],     Condition => [ 841,  426,  406,  400,  146 ], Vocab => 30 },
    { Action => [ 10504, 9150 ],  Condition => [ 542,  143,  0,    0,    0 ],   Vocab => 50 },
    { Action => [ 8005,  7950 ],  Condition => [ 248,  642,  720,  640,  700 ], Vocab => 100 },
    { Action => [ 8005,  0 ],     Condition => [ 248,  542,  1040, 540,  0 ],   Vocab => 100 },
    { Action => [ 6360,  8700 ],  Condition => [ 28,   49,   20,   40,   0 ],   Vocab => 100 },
    { Action => [ 11160, 9150 ],  Condition => [ 288,  260,  280,  0,    0 ],   Vocab => 100 },
    { Action => [ 9660,  0 ],     Condition => [ 248,  240,  0,    0,    0 ],   Vocab => 100 },
    { Action => [ 16558, 17357 ], Condition => [ 269,  260,  0,    0,    0 ],   Vocab => 100 },
    { Action => [ 4110,  9000 ],  Condition => [ 28,   48,   20,   40,   0 ],   Vocab => 100 },
    { Action => [ 9072,  11400 ], Condition => [ 320,  328,  1200, 180,  0 ],   Vocab => 100 },
    { Action => [ 10800, 0 ],     Condition => [ 524,  583,  580,  1220, 0 ],   Vocab => 100 },
    { Action => [ 1350,  0 ],     Condition => [ 1242, 0,    0,    0,    0 ],   Vocab => 4412 },
    { Action => [ 6900,  0 ],     Condition => [ 82,   0,    0,    0,    0 ],   Vocab => 4407 },
    { Action => [ 8902,  17703 ], Condition => [ 142,  421,  420,  140,  0 ],   Vocab => 1521 },
    { Action => [ 2311,  0 ],     Condition => [ 462,  146,  482,  0,    0 ],   Vocab => 1542 },
    { Action => [ 8902,  17703 ], Condition => [ 142,  401,  400,  140,  0 ],   Vocab => 1521 },
    { Action => [ 8864,  8005 ],  Condition => [ 461,  460,  502,  780,  500 ], Vocab => 2742 },
    { Action => [ 7950,  0 ],     Condition => [ 461,  460,  0,    0,    0 ],   Vocab => 2742 },
    { Action => [ 2311,  0 ],     Condition => [ 482,  146,  0,    0,    0 ],   Vocab => 1523 },
    { Action => [ 2400,  0 ],     Condition => [ 482,  141,  266,  0,    0 ],   Vocab => 1523 },
    { Action => [ 10918, 0 ],     Condition => [ 482,  141,  261,  260,  520 ], Vocab => 1523 },
    { Action => [ 9900,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 1533 },
    { Action => [ 7650,  0 ],     Condition => [ 364,  0,    0,    0,    0 ],   Vocab => 8454 },
    { Action => [ 9900,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 5100 },
    { Action => [ 8118,  8614 ],  Condition => [ 581,  344,  460,  0,    0 ],   Vocab => 7209 },
    { Action => [ 2850,  0 ],     Condition => [ 566,  0,    0,    0,    0 ],   Vocab => 2100 },
    { Action => [ 3021,  9209 ],  Condition => [ 621,  561,  620,  0,    0 ],   Vocab => 2125 },
    { Action => [ 8818,  0 ],     Condition => [ 523,  340,  0,    0,    0 ],   Vocab => 8716 },
    { Action => [ 10555, 8720 ],  Condition => [ 622,  561,  620,  240,  0 ],   Vocab => 2125 },
    { Action => [ 8170,  9600 ],  Condition => [ 404,  702,  380,  0,    0 ],   Vocab => 184 },
    { Action => [ 2400,  0 ],     Condition => [ 24,   806,  0,    0,    0 ],   Vocab => 1525 },
    { Action => [ 10918, 0 ],     Condition => [ 24,   801,  800,  620,  0 ],   Vocab => 1525 },
    { Action => [ 10918, 3450 ],  Condition => [ 621,  620,  800,  0,    0 ],   Vocab => 2725 },
    { Action => [ 3300,  0 ],     Condition => [ 362,  561,  0,    0,    0 ],   Vocab => 2125 },
    { Action => [ 17100, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6803 },
    { Action => [ 3750,  0 ],     Condition => [ 384,  0,    0,    0,    0 ],   Vocab => 185 },
    { Action => [ 7918,  0 ],     Condition => [ 762,  760,  505,  0,    0 ],   Vocab => 1510 },
    { Action => [ 7986,  8700 ],  Condition => [ 761,  760,  582,  20,   0 ],   Vocab => 2710 },
    { Action => [ 509,   0 ],     Condition => [ 921,  920,  0,    0,    0 ],   Vocab => 6343 },
    { Action => [ 8902,  17700 ], Condition => [ 122,  261,  260,  240,  0 ],   Vocab => 1513 },
    { Action => [ 8164,  0 ],     Condition => [ 384,  420,  726,  0,    0 ],   Vocab => 900 },
    { Action => [ 8164,  0 ],     Condition => [ 424,  380,  0,    0,    0 ],   Vocab => 900 },
    { Action => [ 3900,  0 ],     Condition => [ 424,  502,  0,    0,    0 ],   Vocab => 185 },
    { Action => [ 8170,  9600 ],  Condition => [ 424,  505,  440,  0,    0 ],   Vocab => 185 },
    { Action => [ 10853, 11400 ], Condition => [ 723,  0,    680,  900,  682 ], Vocab => 8754 },
    { Action => [ 7650,  0 ],     Condition => [ 364,  0,    0,    0,    0 ],   Vocab => 204 },
    { Action => [ 4259,  8008 ],  Condition => [ 521,  502,  520,  480,  280 ], Vocab => 2723 },
    { Action => [ 2400,  0 ],     Condition => [ 122,  266,  0,    0,    0 ],   Vocab => 1513 },
    { Action => [ 300,   0 ],     Condition => [ 62,   0,    0,    0,    0 ],   Vocab => 5751 },
    { Action => [ 8170,  9600 ],  Condition => [ 40,   102,  0,    0,    0 ],   Vocab => 207 },
    { Action => [ 10918, 4350 ],  Condition => [ 241,  240,  260,  367,  0 ],   Vocab => 2713 },
    { Action => [ 8909,  6669 ],  Condition => [ 443,  1201, 440,  1200, 0 ],   Vocab => 8267 },
    { Action => [ 8303,  1050 ],  Condition => [ 100,  102,  292,  80,   221 ], Vocab => 1257 },
    { Action => [ 900,   0 ],     Condition => [ 104,  322,  286,  0,    0 ],   Vocab => 10370 },
    { Action => [ 900,   0 ],     Condition => [ 104,  322,  286,  0,    0 ],   Vocab => 5570 },
    { Action => [ 4558,  7950 ],  Condition => [ 221,  60,   220,  0,    0 ],   Vocab => 3611 },
    { Action => [ 8303,  11400 ], Condition => [ 322,  281,  320,  340,  0 ],   Vocab => 10370 },
    { Action => [ 3750,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 8400 },
    { Action => [ 5011,  0 ],     Condition => [ 384,  721,  0,    0,    0 ],   Vocab => 900 },
    { Action => [ 10853, 11400 ], Condition => [ 723,  0,    680,  900,  682 ], Vocab => 8604 },
    { Action => [ 7918,  4800 ],  Condition => [ 722,  720,  0,    0,    0 ],   Vocab => 1537 },
    { Action => [ 5100,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 4800 },
    { Action => [ 9813,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 3900 },
    { Action => [ 3900,  0 ],     Condition => [ 762,  502,  0,    0,    0 ],   Vocab => 1510 },
    { Action => [ 5303,  8850 ],  Condition => [ 761,  585,  820,  760,  0 ],   Vocab => 2710 },
    { Action => [ 18410, 16710 ], Condition => [ 68,   765,  60,   0,    0 ],   Vocab => 1088 },
    { Action => [ 18339, 9000 ],  Condition => [ 68,   60,   542,  0,    0 ],   Vocab => 1089 },
    { Action => [ 9750,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 4950 },
    { Action => [ 10610, 17055 ], Condition => [ 401,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 10610, 17055 ], Condition => [ 421,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 15300, 0 ],     Condition => [ 364,  0,    0,    0,    0 ],   Vocab => 184 },
    { Action => [ 7650,  0 ],     Condition => [ 682,  0,    0,    0,    0 ],   Vocab => 1554 },
    { Action => [ 6212,  8250 ],  Condition => [ 502,  860,  360,  500,  0 ],   Vocab => 7650 },
    { Action => [ 8003,  8293 ],  Condition => [ 521,  542,  480,  880,  540 ], Vocab => 2723 },
    { Action => [ 9001,  16607 ], Condition => [ 68,   60,   0,    0,    0 ],   Vocab => 1069 },
    { Action => [ 9600,  0 ],     Condition => [ 342,  0,    0,    0,    0 ],   Vocab => 10370 },
    { Action => [ 10554, 9600 ],  Condition => [ 702,  380,  0,    0,    0 ],   Vocab => 166 },
    { Action => [ 8308,  4710 ],  Condition => [ 68,   760,  100,  80,   762 ], Vocab => 1088 },
    { Action => [ 16614, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6761 },
    { Action => [ 197,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 5400 },
    { Action => [ 8170,  9600 ],  Condition => [ 82,   60,   0,    0,    0 ],   Vocab => 207 },
    { Action => [ 8303,  1200 ],  Condition => [ 102,  221,  100,  80,   281 ], Vocab => 1257 },
    { Action => [ 3947,  0 ],     Condition => [ 502,  0,    0,    0,    0 ],   Vocab => 5888 },
    { Action => [ 5897,  0 ],     Condition => [ 542,  0,    0,    0,    0 ],   Vocab => 5889 },
    { Action => [ 509,   7800 ],  Condition => [ 241,  240,  260,  0,    0 ],   Vocab => 6313 },
    { Action => [ 450,   0 ],     Condition => [ 122,  0,    0,    0,    0 ],   Vocab => 6313 },
    { Action => [ 509,   0 ],     Condition => [ 463,  460,  0,    0,    0 ],   Vocab => 6342 },
    { Action => [ 8303,  810 ],   Condition => [ 322,  68,   320,  340,  60 ],  Vocab => 1070 },
    { Action => [ 4950,  0 ],     Condition => [ 524,  10,   0,    0,    0 ],   Vocab => 4050 },
    { Action => [ 8170,  9600 ],  Condition => [ 524,  11,   200,  0,    0 ],   Vocab => 4050 },
    { Action => [ 5700,  0 ],     Condition => [ 226,  0,    0,    0,    0 ],   Vocab => 1200 },
    { Action => [ 12768, 9358 ],  Condition => [ 943,  221,  220,  500,  140 ], Vocab => 7232 },
    { Action => [ 12768, 9366 ],  Condition => [ 221,  527,  220,  500,  0 ],   Vocab => 7232 },
    { Action => [ 7650,  0 ],     Condition => [ 183,  0,    0,    0,    0 ],   Vocab => 4217 },
    { Action => [ 7918,  0 ],     Condition => [ 142,  140,  0,    0,    0 ],   Vocab => 1521 },
    { Action => [ 7403,  8700 ],  Condition => [ 203,  169,  960,  160,  0 ],   Vocab => 4217 },
    { Action => [ 150,   0 ],     Condition => [ 203,  228,  0,    0,    0 ],   Vocab => 4217 },
    { Action => [ 7558,  9209 ],  Condition => [ 203,  208,  220,  960,  0 ],   Vocab => 4217 },
    { Action => [ 7558,  9209 ],  Condition => [ 203,  188,  200,  980,  0 ],   Vocab => 4217 },
    { Action => [ 7403,  8700 ],  Condition => [ 203,  168,  980,  180,  0 ],   Vocab => 4217 },
    { Action => [ 462,   10800 ], Condition => [ 401,  400,  420,  0,    0 ],   Vocab => 7650 },
    { Action => [ 463,   9150 ],  Condition => [ 421,  0,    0,    0,    0 ],   Vocab => 7650 },
    { Action => [ 15300, 0 ],     Condition => [ 527,  0,    0,    0,    0 ],   Vocab => 4050 },
    { Action => [ 150,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 9000 },
    { Action => [ 17785, 18600 ], Condition => [ 222,  0,    0,    0,    0 ],   Vocab => 7232 },
    { Action => [ 1500,  0 ],     Condition => [ 183,  0,    0,    0,    0 ],   Vocab => 2117 },
    { Action => [ 15450, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6807 },
    { Action => [ 8022,  17700 ], Condition => [ 521,  480,  520,  260,  0 ],   Vocab => 2723 },
    { Action => [ 15450, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6780 },
    { Action => [ 15450, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6771 },
    { Action => [ 9062,  17700 ], Condition => [ 68,   60,   524,  220,  200 ], Vocab => 1110 },
    { Action => [ 8170,  9600 ],  Condition => [ 224,  560,  0,    0,    0 ],   Vocab => 207 },
    { Action => [ 16605, 16350 ], Condition => [ 524,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16605, 0 ],     Condition => [ 224,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16605, 0 ],     Condition => [ 384,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16606, 0 ],     Condition => [ 464,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16609, 0 ],     Condition => [ 264,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16609, 0 ],     Condition => [ 344,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16609, 0 ],     Condition => [ 304,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16605, 0 ],     Condition => [ 424,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 16608, 0 ],     Condition => [ 164,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 8005,  0 ],     Condition => [ 281,  322,  340,  320,  0 ],   Vocab => 5570 },
    { Action => [ 8156,  10564 ], Condition => [ 342,  120,  0,    0,    0 ],   Vocab => 206 },
    { Action => [ 10810, 11400 ], Condition => [ 203,  200,  180,  0,    0 ],   Vocab => 2117 },
    { Action => [ 10918, 1426 ],  Condition => [ 183,  180,  200,  0,    0 ],   Vocab => 5567 },
    { Action => [ 1711,  0 ],     Condition => [ 62,   0,    0,    0,    0 ],   Vocab => 1551 },
    { Action => [ 8170,  9600 ],  Condition => [ 1042, 480,  0,    0,    0 ],   Vocab => 166 },
    { Action => [ 16611, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 1549 },
    { Action => [ 3600,  0 ],     Condition => [ 561,  365,  0,    0,    0 ],   Vocab => 2100 },
    { Action => [ 150,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 7650 },
    { Action => [ 8118,  8464 ],  Condition => [ 581,  347,  340,  667,  527 ], Vocab => 7209 },
    { Action => [ 16605, 0 ],     Condition => [ 24,   0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 5700,  0 ],     Condition => [ 226,  0,    0,    0,    0 ],   Vocab => 3611 },
    { Action => [ 16616, 15450 ], Condition => [ 404,  0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 17785, 150 ],   Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 7232 },
    { Action => [ 8170,  9600 ],  Condition => [ 84,   100,  0,    0,    0 ],   Vocab => 166 },
    { Action => [ 7918,  0 ],     Condition => [ 462,  460,  0,    0,    0 ],   Vocab => 1542 },
    { Action => [ 270,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 7050 },
    { Action => [ 197,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 1200 },
    { Action => [ 16800, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 3600 },
    { Action => [ 9122,  150 ],   Condition => [ 68,   60,   0,    0,    0 ],   Vocab => 1050 },
    { Action => [ 17771, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 5315 },
    { Action => [ 150,   0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 4200 },
    { Action => [ 17785, 150 ],   Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 7200 },
    { Action => [ 17850, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6300 },
    { Action => [ 15673, 10800 ], Condition => [ 241,  364,  240,  260,  0 ],   Vocab => 2713 },
    { Action => [ 10800, 0 ],     Condition => [ 2,    1120, 0,    0,    0 ],   Vocab => 0 },
    { Action => [ 7650,  0 ],     Condition => [ 2,    0,    0,    0,    0 ],   Vocab => 1559 },
    { Action => [ 17752, 0 ],     Condition => [ 1122, 1120, 0,    0,    0 ],   Vocab => 1559 },
    { Action => [ 17100, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 6750 },
    { Action => [ 10623, 7500 ],  Condition => [ 1243, 0,    0,    0,    0 ],   Vocab => 5762 },
    { Action => [ 6900,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 4366 },
    { Action => [ 15300, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 900 },
    { Action => [ 17100, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 5868 },
    { Action => [ 3750,  0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 5850 },
    { Action => [ 17825, 11400 ], Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 4350 },
    { Action => [ 18150, 0 ],     Condition => [ 0,    0,    0,    0,    0 ],   Vocab => 1050 },
    { Action => [ 8176,  0 ],     Condition => [ 584,  600,  0,    0,    0 ],   Vocab => 166 }
];

eq_or_diff \@::Actions, $expected_actions,
	'... and the actions read from the db should be correct';

#explain scalar @::Actions, \%::GameHeader;

done_testing;
